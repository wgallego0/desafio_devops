image: ubuntu:latest
stages:
  - build
  - test
  - staging

Teste_api:
  stage: test
  script:
    - echo "Iniciando Stage Testing:"
    - cp -R * /tmp
    - ls -ltr /tmp
    - chmod +x tester1.sh && chmod 777 tester1.sh && chmod +x tester2.sh && chmod 777 tester2.sh
    - apt-get update -qq && apt-get install -y -qq curl && apt-get install sshpass -y 
    - sshpass -p Acqwp2012 ssh -o StrictHostKeyChecking=no -p34722 root@192.168.1.114 "/var/www/html/desafio_devops/app/start_api.sh &"
    - ./tester1.sh
    - ./tester2.sh
    - sshpass -p Acqwp2012 ssh -o StrictHostKeyChecking=no -p34722 root@192.168.1.114 "pkill gunicor"

job_deploy:
  stage: staging
  needs: ["Teste_api"]
  script:
    - apt-get update -y && apt-get install sshpass -y
    - sshpass -p Acqwp2012 scp -o stricthostkeychecking=no -r * root@192.168.1.114:/app/
